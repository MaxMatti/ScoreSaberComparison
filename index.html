<!DOCTYPE html PUBLIC"-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
	<meta content="utf-8" http-equiv="encoding">
	<title>ScoreSaber-Comparison</title>
	<style type="text/css">
		button {
			border-style: outset;
			margin: 0;
			padding: 0.1cm;
		}

		img.albumcover {
			height: 1cm;
			float: left;
			margin-right: 0.1cm;
		}
		td {
			padding: 0.1cm;
		}
		tbody#mainBody > tr:nth-child(2n), thead#mainHeader > tr:nth-child(2n+1) {
			background-color: #ffffff;
		}
		tbody#mainBody > tr:nth-child(2n+1), thead#mainHeader > tr:nth-child(2n) {
			background-color: #cccccc;
		}
	</style>
	<script type="text/javascript">

		// change these variables to change the settings
		var playerCount = 2;
		var requestInterval = 100;
		var scoreRefreshInterval = 200;

		// do not change these variables unless you know what you're doing
		var difficulties = ["Easy", "Easy", "Normal", "Normal", "Hard", "Hard", "Expert", "Expert", "Expert+", "Expert+"];
		var loaded = false;
		var songs = {};
		var users = Array.from('0'.repeat(playerCount + 1));
		var players = {};
		var lastScoreUpdate = 0;
		var scoreUpdateTimeout;

		// this function increments the last number in a string. e.g. "abc123" => "abc124"
		// TODO: unfinished, currently does 19 -> 110
		function incrementLastNumber(input) {
			return input.replace(/\d*(?=\D*$)/gi, function(i) { return isNaN(parseInt(i)) ? i : parseInt(i) + 1; })
		}

		function maybeUpdateScores() {
			if (scoreUpdateTimeout) {
				return;
			}
			if (lastScoreUpdate > Date.now() - scoreRefreshInterval) {
				scoreUpdateTimeout = window.setTimeout(updateScores, scoreRefreshInterval);
				return;
			}
			updateScores();
		}

		function updateScores() {
			scoreUpdateTimeout = 0;

			for (var leaderboardId in songs) {
				var row = document.getElementById("song-" + leaderboardId);
				if (!row) {
					var firstUser = Object.keys(songs[leaderboardId])[0];
					var firstCol = document.createElement("td");
					firstCol.innerHTML = "<img src=\"https://scoresaber.com/imports/images/songs/" + songs[leaderboardId][firstUser].songHash + ".png\" class=\"albumcover\" />" + songs[leaderboardId][firstUser].songName + " " + songs[leaderboardId][firstUser].songSubName + " (" + difficulties[songs[leaderboardId][firstUser].difficulty] + ")<br />by " + songs[leaderboardId][firstUser].songAuthorName + " and " + songs[leaderboardId][firstUser].levelAuthorName;
					row = document.createElement("tr");
					row.appendChild(firstCol);
					for (var i = 1; i < users.length; ++i) {
						var nextCol = document.createElement("td");
						nextCol.id = "score-" + leaderboardId + "-" + users[i];
						row.appendChild(nextCol);
					}
					row.id = "song-" + leaderboardId;
					document.getElementById("mainBody").appendChild(row);
				}
				for (var i = 0; i < users.length; ++i) {
					row.children[i].id = "score-" + leaderboardId + "-" + users[i];
				}
				for (var user in songs[leaderboardId]) {
					var col = document.getElementById("score-" + leaderboardId + "-" + user);
					if (!col) {
						console.log("User not found: " + "score-" + leaderboardId + "-" + user);
						continue;
					}
					var percent = parseInt(songs[leaderboardId][user].maxScore) > parseInt(songs[leaderboardId][user].unmodififiedScore) ? (parseInt(songs[leaderboardId][user].unmodififiedScore) / parseInt(songs[leaderboardId][user].maxScore) * 100) : 0;
					col.innerHTML = "#" + songs[leaderboardId][user].rank + " - score: " + songs[leaderboardId][user].score + "<br />(" + songs[leaderboardId][user].pp.toFixed(2) + "pp aka " + percent.toFixed(2) + "%)";
				}
			}
		}

		function addScores() {
			var result = JSON.parse(this.responseText);
			if ("scores" in result) {
				for (var i = 0; i < result.scores.length; ++i) {
					if (!(result.scores[i].leaderboardId in songs)) {
						songs[result.scores[i].leaderboardId] = {};
					}
					songs[result.scores[i].leaderboardId][this.responseURL.split("/", 6)[5]] = result.scores[i];
				}
				if (result.scores.length > 0) {
					window.setTimeout(function (url) { return function () {
						var xhr = new XMLHttpRequest();
						xhr.open("GET", url);
						xhr.addEventListener("load", addScores, true);
						xhr.send();
					}; }(incrementLastNumber(this.responseURL)), requestInterval);
				}
				maybeUpdateScores();
			}
		}

		function addPlayer() {
			try {
				var result = JSON.parse(this.responseText);
			} catch (e) {
				console.log(this.responseText);
			}
			players[result.playerInfo.playerId] = result;
			for (var i = 0; i < users.length; ++i) {
				document.getElementById("playerInfo").children[i].id = "info-" + users[i];
			}
			document.getElementById("info-" + result.playerInfo.playerId).innerHTML = result.playerInfo.playerName + " - " + result.playerInfo.pp.toFixed(2) + "pp<br />Rank: #" + result.playerInfo.rank + " (#" + result.playerInfo.countryRank + " in " + result.playerInfo.country + ")";
		}

		function updateUser(index) {
			var xhr1 = new XMLHttpRequest();
			xhr1.open("GET", "https://new.scoresaber.com/api/player/" + encodeURIComponent(users[index]) + "/scores/top/1");
			xhr1.addEventListener("load", addScores, true);
			xhr1.send();
			var xhr2 = new XMLHttpRequest();
			xhr2.open("GET", "https://new.scoresaber.com/api/player/" + encodeURIComponent(users[index]) + "/full")
			xhr2.addEventListener("load", addPlayer, true);
			xhr2.send();
			window.location.hash = users.slice(1).join("#");
		}

		function textInput(e) {
			if (e.key == "Enter") {
				users[e.currentTarget.dataset.column] = e.currentTarget.value;
				// getSteamID(e.currentTarget.value, function (f) { console.log(f); });
				updateUser(e.currentTarget.dataset.column);
			}
		}

		function resize(arr, newSize, defaultValue) {
		    while(newSize > arr.length) {
		        arr.push(defaultValue);
		    }
		    arr.length = newSize;
		}

		function load(e) {
			// ensure this function is only executed once
			if (loaded) {
				return;
			}
			// ensure the table already exists
			if (!document.getElementById("mainTable")) {
				return;
			}
			loaded = true;

			users = window.location.hash.split("#");
			resize(users, playerCount + 1, "");

			for (var i = 0; i < playerCount; ++i) {
				var playerInputField = document.createElement("input");
				playerInputField.type = "text";
				playerInputField.placeholder = "Player " + (i + 1) + " ID";
				playerInputField.value = users[i + 1];
				playerInputField.dataset.column = i + 1;
				playerInputField.addEventListener("keydown", textInput, true);
				var playerInputCell = document.createElement("td");
				playerInputCell.className = "playerInput";
				playerInputCell.appendChild(playerInputField);
				document.getElementById("playerInputRow").appendChild(playerInputCell);
				var playerInfoCell = document.createElement("td");
				playerInfoCell.className = "playerInfo";
				document.getElementById("playerInfo").appendChild(playerInfoCell);
				var playerSortingCell = document.createElement("td");
				playerSortingCell.className = "playerSorting";
				playerSortingCell.dataset.column = i + 1;
				var sortRankBtn = document.createElement("button");
				sortRankBtn.innerHTML = "Rank";
				sortRankBtn.addEventListener("click", sortByUser(function (obj) { return -obj.rank; }), true);
				playerSortingCell.appendChild(sortRankBtn);
				var sortScoreBtn = document.createElement("button");
				sortScoreBtn.innerHTML = "Score";
				sortScoreBtn.addEventListener("click", sortByUser(function (obj) { return obj.score; }), true);
				playerSortingCell.appendChild(sortScoreBtn);
				var sortPpBtn = document.createElement("button");
				sortPpBtn.innerHTML = "PP";
				sortPpBtn.addEventListener("click", sortByUser(function (obj) { return obj.pp; }), true);
				playerSortingCell.appendChild(sortPpBtn);
				var sortPercentBtn = document.createElement("button");
				sortPercentBtn.innerHTML = "Percent";
				sortPercentBtn.addEventListener("click", sortByUser(function (obj) { return parseInt(obj.maxScore) > parseInt(obj.unmodififiedScore) ? (parseInt(obj.unmodififiedScore) / parseInt(obj.maxScore) * 100) : 0; }), true);
				playerSortingCell.appendChild(sortPercentBtn);
				document.getElementById("sortingRow").appendChild(playerSortingCell);
				updateUser(i + 1);
			}
			document.getElementById("sortby-songName").addEventListener("click", sortBySimple(function (obj) { return obj.songName; }), true);
			document.getElementById("sortby-songAuthorName").addEventListener("click", sortBySimple(function (obj) { return obj.songAuthorName; }), true);
			document.getElementById("sortby-levelAuthorName").addEventListener("click", sortBySimple(function (obj) { return obj.levelAuthorName; }), true);
		}

		function sortBySimple(sortingFunction) {
			return function (e) {
				var sortedSongs = Object.keys(songs);
				sortedSongs.sort(function (a, b) {
					var tmp1 = sortingFunction(songs[a][Object.keys(songs[a])[0]]);
					var tmp2 = sortingFunction(songs[b][Object.keys(songs[b])[0]]);
					return tmp1 > tmp2 ? 1 : tmp1 < tmp2 ? -1 : 0;
				});
				for (var i = 0; i < sortedSongs.length; ++i) {
					var row = document.getElementById("song-" + sortedSongs[i]);
					row.parentNode.appendChild(row);
				}
			};
		}

		function sortByUser(sortingFunction) {
			return function (e) {
				var username = users[e.currentTarget.parentNode.dataset.column];
				var sortedSongs = Object.keys(songs);
				sortedSongs.sort(function (a, b) {
					if (!(username in songs[a]) && !(username in songs[b])) {
						return 0;
					} else if (!(username in songs[a])) {
						return 1;
					} else if (!(username in songs[b])) {
						return -1;
					}
					var tmp1 = sortingFunction(songs[a][username]);
					var tmp2 = sortingFunction(songs[b][username]);
					return tmp1 < tmp2 ? 1 : tmp1 > tmp2 ? -1 : 0;
				});
				for (var i = 0; i < sortedSongs.length; ++i) {
					var row = document.getElementById("song-" + sortedSongs[i]);
					row.parentNode.appendChild(row);
				}
			};
		}

		// does not work atm due to CORS - might look into that later
		function getSteamID(inputString, callback) {
			var request = new XMLHttpRequest();
			request.open("POST", "https://steamid.io/lookup", true);
			request.setRequestHeader("content-type", "text/html; charset=UTF-8");
			request.addEventListener("load", function () {
				var url = request.responseURL;
				if (url.startsWith("https://steamid.io/lookup/")) {
					callback(url.substr(26));
				} else {
					callback();
				}
			}, true);
			request.send("input=" + encodeURIComponent(inputString));
		}

		window.addEventListener("load", load, true);
	</script>
</head>
<body>
	<table id="mainTable">
		<thead id="mainHeader">
			<tr id="playerInputRow"><td>Song</td></tr>
			<tr id="playerInfo"><td>Player info:</td></tr>
			<tr id="sortingRow"><td>Sort by: <button id="sortby-songName">Title</button><button id="sortby-songAuthorName">Song Author</button><button id="sortby-levelAuthorName">Level Author</button></td></tr>
		</thead>
		<tbody id="mainBody"></tbody>
	</table>
</body>
</html>